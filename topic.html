<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帖子详情 - 静态API论坛</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="logo">API论坛</a>
        <div class="nav-links">
            <a href="index.html" class="nav-link">返回首页</a>
            <a href="create.html" class="nav-link">发帖</a>
            <div class="user-info" id="userInfo">
                <a href="login.html" class="nav-link">登录/注册</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- 帖子内容区域 -->
        <div id="postContent" class="card loading">
            <div class="spinner"></div>
            <p>正在加载帖子...</p>
        </div>
        
        <!-- 评论区域 -->
        <div class="card">
            <h3>评论</h3>
            <div id="commentsList">
                <p style="color: #718096;">加载评论中...</p>
            </div>
            
            <!-- 添加评论表单 -->
            <div id="addCommentForm" style="margin-top: 2rem;">
                <div class="form-group">
                    <label class="form-label">添加评论</label>
                    <textarea id="commentContent" class="form-input" placeholder="请输入您的评论" rows="3"></textarea>
                </div>
                <button id="submitComment" class="btn">提交评论</button>
                <div id="commentMessage" style="margin-top: 1rem; padding: 0.5rem; border-radius: 5px; display: none;"></div>
            </div>
        </div>
    </div>

    <!-- 脚本 -->
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/forum.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // 检查用户登录状态
            await checkAuth();
            
            // 从URL获取帖子ID
            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id');
            
            if (!postId) {
                document.getElementById('postContent').innerHTML = '<p>帖子不存在</p>';
                return;
            }
            
            // 加载帖子详情和评论
            await loadPostDetails(postId);
            
            // 设置提交评论事件
            document.getElementById('submitComment').addEventListener('click', async function() {
                const content = document.getElementById('commentContent').value.trim();
                
                if (!content) {
                    showCommentMessage('请输入评论内容', 'error');
                    return;
                }
                
                const user = await getCurrentUser();
                if (!user) {
                    showCommentMessage('请先登录才能评论', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1500);
                    return;
                }
                
                // 禁用按钮防止重复提交
                this.disabled = true;
                this.textContent = '提交中...';
                
                const result = await addComment(postId, content);
                
                if (result.success) {
                    showCommentMessage('评论发布成功！', 'success');
                    document.getElementById('commentContent').value = '';
                    
                    // 重新加载评论
                    await loadComments(postId);
                } else {
                    showCommentMessage(`评论失败: ${result.error}`, 'error');
                }
                
                this.disabled = false;
                this.textContent = '提交评论';
            });
        });
        
        // 加载帖子详情
        async function loadPostDetails(postId) {
            const postContentDiv = document.getElementById('postContent');
            
            try {
                const result = await loadPost(postId);
                
                if (!result.post) {
                    postContentDiv.innerHTML = '<p>帖子不存在或已被删除</p>';
                    return;
                }
                
                const post = result.post;
                const authorName = post.profiles?.username || '匿名用户';
                const category = getCategoryText(post.category);
                const postTime = formatTime(post.created_at);
                
                // 渲染帖子内容
                postContentDiv.innerHTML = `
                    <div style="margin-bottom: 1.5rem;">
                        <span class="category-tag">${category}</span>
                        <h1>${post.title}</h1>
                        <div class="post-meta" style="margin-top: 0.5rem;">
                            <span class="post-author">${authorName}</span>
                            <span>${postTime}</span>
                            <span>评论: ${post.comment_count || 0}</span>
                        </div>
                    </div>
                    
                    <div style="line-height: 1.8; font-size: 1.1rem;">
                        ${formatPostContent(post.content)}
                    </div>
                `;
                
                // 加载评论
                await loadComments(postId, result.comments);
            } catch (error) {
                console.error('加载帖子详情错误:', error);
                postContentDiv.innerHTML = '<p>加载帖子失败，请稍后重试</p>';
            }
        }
        
        // 加载评论
        async function loadComments(postId, comments = null) {
            const commentsListDiv = document.getElementById('commentsList');
            
            if (!comments) {
                // 如果没有传入评论，从API加载
                const result = await loadPost(postId);
                comments = result.comments;
            }
            
            if (!comments || comments.length === 0) {
                commentsListDiv.innerHTML = '<p>暂无评论，快来发表第一条评论吧！</p>';
                return;
            }
            
            commentsListDiv.innerHTML = '';
            
            comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'comment';
                
                const authorName = comment.profiles?.username || '匿名用户';
                const commentTime = formatTime(comment.created_at);
                
                commentElement.innerHTML = `
                    <div class="comment-meta">
                        <span class="post-author">${authorName}</span>
                        <span>${commentTime}</span>
                    </div>
                    <div class="comment-content">
                        ${formatPostContent(comment.content)}
                    </div>
                `;
                
                commentsListDiv.appendChild(commentElement);
            });
        }
        
        // 格式化帖子内容（简单Markdown支持）
        function formatPostContent(content) {
            if (!content) return '';
            
            // 替换换行符
            let formatted = content.replace(/\n/g, '<br>');
            
            // 简单Markdown转换
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            formatted = formatted.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            return formatted;
        }
        
        function showCommentMessage(text, type) {
            const messageDiv = document.getElementById('commentMessage');
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';
            messageDiv.style.backgroundColor = type === 'success' ? '#d4edda' : '#f8d7da';
            messageDiv.style.color = type === 'success' ? '#155724' : '#721c24';
            messageDiv.style.border = type === 'success' ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
            
            // 3秒后隐藏消息
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
  </html>
