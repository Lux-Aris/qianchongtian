<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>发布新帖子 - 内部技术论坛</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="logo">内部技术论坛</a>
        <div class="nav-links">
            <a href="index.html" class="nav-link">返回首页</a>
            <div class="user-info">
                <span>内部使用</span>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card" style="max-width: 800px; margin: 2rem auto;">
            <h2>发布新帖子</h2>
            
            <!-- 发帖人姓名 -->
            <div class="form-group">
                <label class="form-label">你的名字</label>
                <input type="text" id="authorName" class="form-input" placeholder="请输入您的姓名或昵称" required>
            </div>
            
            <!-- 帖子标题 -->
            <div class="form-group">
                <label class="form-label">标题</label>
                <input type="text" id="postTitle" class="form-input" placeholder="请输入帖子标题" required>
            </div>
            
            <!-- 帖子分类 -->
            <div class="form-group">
                <label class="form-label">分类</label>
                <select id="postCategory" class="form-input">
                    <option value="general">综合讨论</option>
                    <option value="tech">技术交流</option>
                    <option value="help">求助问答</option>
                    <option value="feedback">反馈建议</option>
                </select>
            </div>
            
            <!-- 帖子内容 -->
            <div class="form-group">
                <label class="form-label">内容</label>
                <textarea id="postContent" class="form-input" placeholder="请输入帖子内容..." rows="6" required></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button id="submitPost" class="btn">发布帖子</button>
                <a href="index.html" class="btn btn-secondary">取消</a>
            </div>
            
            <div id="message" style="margin-top: 1.5rem; padding: 1rem; border-radius: 5px; display: none;"></div>
        </div>
    </div>

    <!-- 脚本 -->
    <script src="js/supabase.js"></script>
    <script src="js/forum.js"></script> <!-- 注意：不再引入 auth.js -->
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('submitPost').addEventListener('click', async function() {
                // 1. 获取表单数据
                const authorName = document.getElementById('authorName').value.trim();
                const title = document.getElementById('postTitle').value.trim();
                const content = document.getElementById('postContent').value.trim();
                const category = document.getElementById('postCategory').value;
                
                // 2. 简单验证
                if (!authorName || !title || !content) {
                    showMessage('请填写姓名、标题和内容', 'error');
                    return;
                }
                
                // 3. 禁用按钮防止重复提交
                this.disabled = true;
                this.textContent = '发布中...';
                
                // 4. 调用新的简化发帖函数
                const result = await createPostSimple(title, content, category, authorName);
                
                // 5. 处理结果
                if (result.success) {
                    showMessage('帖子发布成功！正在跳转...', 'success');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                } else {
                    showMessage(`发布失败: ${result.error}`, 'error');
                    this.disabled = false;
                    this.textContent = '发布帖子';
                }
            });
        });
        
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';
            messageDiv.style.backgroundColor = type === 'success' ? '#d4edda' : '#f8d7da';
            messageDiv.style.color = type === 'success' ? '#155724' : '#721c24';
        }
    </script>
</body>
</html>
