<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>发布新帖子 - 静态API论坛</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="logo">API论坛</a>
        <div class="nav-links">
            <a href="index.html" class="nav-link">返回首页</a>
            <div class="user-info" id="userInfo">
                <a href="login.html" class="nav-link">登录/注册</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card" style="max-width: 800px; margin: 2rem auto;">
            <h2>发布新帖子</h2>
            
            <div class="form-group">
                <label class="form-label">标题</label>
                <input type="text" id="postTitle" class="form-input" placeholder="请输入帖子标题">
            </div>
            
            <div class="form-group">
                <label class="form-label">分类</label>
                <select id="postCategory" class="form-input">
                    <option value="general">综合讨论</option>
                    <option value="tech">技术交流</option>
                    <option value="help">求助问答</option>
                    <option value="feedback">反馈建议</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">内容</label>
                <textarea id="postContent" class="form-input" placeholder="请输入帖子内容（支持Markdown格式）"></textarea>
                <p style="font-size: 0.9rem; color: #718096; margin-top: 0.5rem;">
                    提示：您可以使用 **粗体**、*斜体*、[链接](http://example.com) 等Markdown格式
                </p>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button id="submitPost" class="btn">发布帖子</button>
                <a href="index.html" class="btn btn-secondary">取消</a>
            </div>
            
            <div id="message" style="margin-top: 1.5rem; padding: 1rem; border-radius: 5px; display: none;"></div>
        </div>
    </div>

    <!-- 脚本 -->
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/forum.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // 检查用户登录状态
            const user = await checkAuth();
            
            if (!user) {
                showMessage('请先登录才能发布帖子', 'error');
                document.getElementById('submitPost').disabled = true;
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            // 提交帖子事件
            document.getElementById('submitPost').addEventListener('click', async function() {
                const title = document.getElementById('postTitle').value.trim();
                const content = document.getElementById('postContent').value.trim();
                const category = document.getElementById('postCategory').value;
                
                if (!title || !content) {
                    showMessage('请填写标题和内容', 'error');
                    return;
                }
                
                if (title.length < 3) {
                    showMessage('标题至少需要3个字符', 'error');
                    return;
                }
                
                if (content.length < 10) {
                    showMessage('内容至少需要10个字符', 'error');
                    return;
                }
                
                // 禁用按钮防止重复提交
                this.disabled = true;
                this.textContent = '发布中...';
                
                const result = await createPost(title, content, category);
                
                if (result.success) {
                    showMessage('帖子发布成功！正在跳转...', 'success');
                    setTimeout(() => {
                        window.location.href = `topic.html?id=${result.post.id}`;
                    }, 1500);
                } else {
                    showMessage(`发布失败: ${result.error}`, 'error');
                    this.disabled = false;
                    this.textContent = '发布帖子';
                }
            });
        });
        
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';
            messageDiv.style.backgroundColor = type === 'success' ? '#d4edda' : '#f8d7da';
            messageDiv.style.color = type === 'success' ? '#155724' : '#721c24';
            messageDiv.style.border = type === 'success' ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
        }
    </script>
</body>
</html>
